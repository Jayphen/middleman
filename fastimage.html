<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>fastimage.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="middleman.html">middleman.rb</a>
          <a class="source" href="assets.html">assets.rb</a>
          <a class="source" href="builder.html">builder.rb</a>
          <a class="source" href="features.html">features.rb</a>
          <a class="source" href="asset_host.html">asset_host.rb</a>
          <a class="source" href="automatic_image_sizes.html">automatic_image_sizes.rb</a>
          <a class="source" href="fastimage.html">fastimage.rb</a>
          <a class="source" href="cache_buster.html">cache_buster.rb</a>
          <a class="source" href="code_ray.html">code_ray.rb</a>
          <a class="source" href="default_helpers.html">default_helpers.rb</a>
          <a class="source" href="live_reload.html">live_reload.rb</a>
          <a class="source" href="lorem.html">lorem.rb</a>
          <a class="source" href="minify_css.html">minify_css.rb</a>
          <a class="source" href="minify_javascript.html">minify_javascript.rb</a>
          <a class="source" href="rack.html">rack.rb</a>
          <a class="source" href="relative_assets.html">relative_assets.rb</a>
          <a class="source" href="slickmap.html">slickmap.rb</a>
          <a class="source" href="smush_pngs.html">smush_pngs.rb</a>
          <a class="source" href="ugly_haml.html">ugly_haml.rb</a>
          <a class="source" href="haml.html">haml.rb</a>
          <a class="source" href="sass.html">sass.rb</a>
          <a class="source" href="server.html">server.rb</a>
          <a class="source" href="version.html">version.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>fastimage.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <p> FastImage finds the size or type of an image given its uri.
 It is careful to only fetch and parse as much of the image as is needed to determine the result.
 It does this by using a feature of Net::HTTP that yields strings from the resource being fetched
 as soon as the packets arrive.</p>

<p> No external libraries such as ImageMagick are used here, this is a very lightweight solution to
 finding image information.</p>

<p> FastImage knows about GIF, JPEG, BMP and PNG files.</p>

<p> FastImage can also read files from the local filesystem by supplying the path instead of a uri.
 In this case FastImage uses the open-uri library to read the file in chunks of 256 bytes until
 it has enough. This is possibly a useful bandwidth-saving feature if the file is on a network
 attached disk rather than truly local.</p>

<p> === Examples
   require &lsquo;fastimage&rsquo;</p>

<p>   FastImage.size(&ldquo;http://stephensykes.com/images/ss.com_x.gif&rdquo;)
   => [266, 56]
   FastImage.type(&ldquo;http://stephensykes.com/images/pngimage&rdquo;)
   => :png
   FastImage.type(&ldquo;/some/local/file.gif&rdquo;)
   => :gif</p>

<p> === References
 * http://snippets.dzone.com/posts/show/805
 * http://www.anttikupila.com/flash/getting-jpg-dimensions-with-as3-without-loading-the-entire-file/
 * http://pennysmalls.com/2008/08/19/find-jpeg-dimensions-fast-in-ruby/
 * http://imagesize.rubyforge.org/</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;net/https&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;open-uri&#39;</span>

<span class="k">class</span> <span class="nc">FastImage</span>
  <span class="kp">attr_reader</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">:type</span>

  <span class="k">class</span> <span class="nc">FastImageException</span> <span class="o">&lt;</span> <span class="no">StandardError</span> <span class="c1"># :nodoc:</span>
  <span class="k">end</span>
  <span class="k">class</span> <span class="nc">MoreCharsNeeded</span> <span class="o">&lt;</span> <span class="no">FastImageException</span> <span class="c1"># :nodoc:</span>
  <span class="k">end</span>
  <span class="k">class</span> <span class="nc">UnknownImageType</span> <span class="o">&lt;</span> <span class="no">FastImageException</span> <span class="c1"># :nodoc:</span>
  <span class="k">end</span>
  <span class="k">class</span> <span class="nc">ImageFetchFailure</span> <span class="o">&lt;</span> <span class="no">FastImageException</span> <span class="c1"># :nodoc:</span>
  <span class="k">end</span>
  <span class="k">class</span> <span class="nc">SizeNotFound</span> <span class="o">&lt;</span> <span class="no">FastImageException</span> <span class="c1"># :nodoc:</span>
  <span class="k">end</span>

  <span class="no">DefaultTimeout</span> <span class="o">=</span> <span class="mi">2</span>
  
  <span class="no">LocalFileChunkSize</span> <span class="o">=</span> <span class="mi">256</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p> Returns an array containing the width and height of the image.
 It will return nil if the image could not be fetched, or if the image type was not recognised.</p>

<p> By default there is a timeout of 2 seconds for opening and reading from a remote server.
 This can be changed by passing a :timeout => number_of_seconds in the options.</p>

<p> If you wish FastImage to raise if it cannot size the image for any reason, then pass
 :raise_on_failure => true in the options.</p>

<p> FastImage knows about GIF, JPEG, BMP and PNG files.</p>

<p> === Example</p>

<p>   require &lsquo;fastimage&rsquo;</p>

<p>   FastImage.size(&ldquo;http://stephensykes.com/images/ss.com_x.gif&rdquo;)
   => [266, 56]
   FastImage.size(&ldquo;http://stephensykes.com/images/pngimage&rdquo;)
   => [16, 16]
   FastImage.size(&ldquo;http://farm4.static.flickr.com/3023/3047236863_9dce98b836.jpg&rdquo;)
   => [500, 375]
   FastImage.size(&ldquo;http://www-ece.rice.edu/~wakin/images/lena512.bmp&rdquo;)
   => [512, 512]
   FastImage.size(&ldquo;test/fixtures/test.jpg&rdquo;)
   => [882, 470]
   FastImage.size(&ldquo;http://pennysmalls.com/does_not_exist&rdquo;)
   => nil
   FastImage.size(&ldquo;http://pennysmalls.com/does_not_exist&rdquo;, :raise_on_failure=>true)
   => raises FastImage::ImageFetchFailure
   FastImage.size(&ldquo;http://stephensykes.com/favicon.ico&rdquo;, :raise_on_failure=>true)
   => raises FastImage::UnknownImageType
   FastImage.size(&ldquo;http://stephensykes.com/favicon.ico&rdquo;, :raise_on_failure=>true, :timeout=>0.01)
   => raises FastImage::ImageFetchFailure
   FastImage.size(&ldquo;http://stephensykes.com/images/faulty.jpg&rdquo;, :raise_on_failure=>true)
   => raises FastImage::SizeNotFound</p>

<p> === Supported options
 [:timeout]
   Overrides the default timeout of 2 seconds.  Applies both to reading from and opening the http connection.
 [:raise_on_failure]
   If set to true causes an exception to be raised if the image size cannot be found for any reason.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">size</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span>
    <span class="kp">new</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p> Returns an symbol indicating the image type fetched from a uri.
 It will return nil if the image could not be fetched, or if the image type was not recognised.</p>

<p> By default there is a timeout of 2 seconds for opening and reading from a remote server.
 This can be changed by passing a :timeout => number_of_seconds in the options.</p>

<p> If you wish FastImage to raise if it cannot find the type of the image for any reason, then pass
 :raise_on_failure => true in the options.</p>

<p> === Example</p>

<p>   require &lsquo;fastimage&rsquo;</p>

<p>   FastImage.type(&ldquo;http://stephensykes.com/images/ss.com_x.gif&rdquo;)
   => :gif
   FastImage.type(&ldquo;http://stephensykes.com/images/pngimage&rdquo;)
   => :png
   FastImage.type(&ldquo;http://farm4.static.flickr.com/3023/3047236863_9dce98b836.jpg&rdquo;)
   => :jpeg
   FastImage.type(&ldquo;http://www-ece.rice.edu/~wakin/images/lena512.bmp&rdquo;)
   => :bmp
   FastImage.type(&ldquo;test/fixtures/test.jpg&rdquo;)
   => :jpeg
   FastImage.type(&ldquo;http://pennysmalls.com/does_not_exist&rdquo;)
   => nil</p>

<p> === Supported options
 [:timeout]
   Overrides the default timeout of 2 seconds.  Applies both to reading from and opening the http connection.
 [:raise_on_failure]
   If set to true causes an exception to be raised if the image type cannot be found for any reason.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">type</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span>
    <span class="kp">new</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:type_only</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">))</span><span class="o">.</span><span class="n">type</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span>
    <span class="vi">@property</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:type_only</span><span class="o">]</span> <span class="p">?</span> <span class="ss">:type</span> <span class="p">:</span> <span class="ss">:size</span>
    <span class="vi">@timeout</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:timeout</span><span class="o">]</span> <span class="o">||</span> <span class="no">DefaultTimeout</span>
    <span class="vi">@uri</span> <span class="o">=</span> <span class="n">uri</span>
    <span class="k">begin</span>
      <span class="vi">@parsed_uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="k">rescue</span> <span class="no">URI</span><span class="o">::</span><span class="no">InvalidURIError</span>
      <span class="n">fetch_using_open_uri</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="vi">@parsed_uri</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;http&quot;</span> <span class="o">||</span> <span class="vi">@parsed_uri</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span>
        <span class="n">fetch_using_http</span>
      <span class="k">else</span>
        <span class="n">fetch_using_open_uri</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">raise</span> <span class="no">SizeNotFound</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:raise_on_failure</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="vi">@property</span> <span class="o">==</span> <span class="ss">:size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="vi">@size</span>
  <span class="k">rescue</span> <span class="no">Timeout</span><span class="o">::</span><span class="no">Error</span><span class="p">,</span> <span class="no">SocketError</span><span class="p">,</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ECONNREFUSED</span><span class="p">,</span> <span class="no">Errno</span><span class="o">::</span><span class="no">EHOSTUNREACH</span><span class="p">,</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ECONNRESET</span><span class="p">,</span> 
    <span class="no">ImageFetchFailure</span><span class="p">,</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTPBadResponse</span><span class="p">,</span> <span class="no">EOFError</span><span class="p">,</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ENOENT</span>
    <span class="k">raise</span> <span class="no">ImageFetchFailure</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:raise_on_failure</span><span class="o">]</span>
  <span class="k">rescue</span> <span class="no">NoMethodError</span>  <span class="c1"># 1.8.7p248 can raise this due to a net/http bug</span>
    <span class="k">raise</span> <span class="no">ImageFetchFailure</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:raise_on_failure</span><span class="o">]</span>
  <span class="k">rescue</span> <span class="no">UnknownImageType</span>
    <span class="k">raise</span> <span class="no">UnknownImageType</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:raise_on_failure</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">fetch_using_http</span>
    <span class="n">setup_http</span>
    <span class="vi">@http</span><span class="o">.</span><span class="n">request_get</span><span class="p">(</span><span class="vi">@parsed_uri</span><span class="o">.</span><span class="n">request_uri</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">res</span><span class="o">|</span>
      <span class="k">raise</span> <span class="no">ImageFetchFailure</span> <span class="k">unless</span> <span class="n">res</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Net</span><span class="o">::</span><span class="no">HTTPSuccess</span><span class="p">)</span>
      <span class="n">res</span><span class="o">.</span><span class="n">read_body</span> <span class="k">do</span> <span class="o">|</span><span class="n">str</span><span class="o">|</span>
        <span class="k">break</span> <span class="k">if</span> <span class="n">parse_packet</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">setup_http</span>
    <span class="vi">@http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@parsed_uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="vi">@parsed_uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
    <span class="vi">@http</span><span class="o">.</span><span class="n">use_ssl</span> <span class="o">=</span> <span class="p">(</span><span class="vi">@parsed_uri</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">)</span>
    <span class="vi">@http</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">VERIFY_NONE</span>
    <span class="vi">@http</span><span class="o">.</span><span class="n">open_timeout</span> <span class="o">=</span> <span class="vi">@timeout</span>
    <span class="vi">@http</span><span class="o">.</span><span class="n">read_timeout</span> <span class="o">=</span> <span class="vi">@timeout</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">fetch_using_open_uri</span>
    <span class="nb">open</span><span class="p">(</span><span class="vi">@uri</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
      <span class="k">while</span> <span class="n">str</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">LocalFileChunkSize</span><span class="p">)</span>
        <span class="k">break</span> <span class="k">if</span> <span class="n">parse_packet</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p> returns true once result is achieved</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">parse_packet</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="vi">@str</span> <span class="o">=</span> <span class="p">(</span><span class="vi">@unused_str</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">str</span>
    <span class="vi">@strpos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">begin</span>
      <span class="n">result</span> <span class="o">=</span> <span class="nb">send</span><span class="p">(</span><span class="s2">&quot;parse_</span><span class="si">#{</span><span class="vi">@property</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">result</span> 
        <span class="nb">instance_variable_set</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="vi">@property</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">rescue</span> <span class="no">MoreCharsNeeded</span>
      <span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse_size</span>
    <span class="vi">@type</span> <span class="o">=</span> <span class="n">parse_type</span> <span class="k">unless</span> <span class="vi">@type</span>
    <span class="vi">@strpos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">send</span><span class="p">(</span><span class="s2">&quot;parse_size_for_</span><span class="si">#{</span><span class="vi">@type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_chars</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@strpos</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="vi">@str</span><span class="o">.</span><span class="n">size</span>
      <span class="vi">@unused_str</span> <span class="o">=</span> <span class="vi">@str</span><span class="o">[</span><span class="vi">@strpos</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
      <span class="k">raise</span> <span class="no">MoreCharsNeeded</span>
    <span class="k">else</span>
      <span class="n">result</span> <span class="o">=</span> <span class="vi">@str</span><span class="o">[</span><span class="vi">@strpos</span><span class="o">.</span><span class="n">.</span><span class="p">(</span><span class="vi">@strpos</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">]</span>
      <span class="vi">@strpos</span> <span class="o">+=</span> <span class="n">n</span>
      <span class="n">result</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_byte</span>
    <span class="n">get_chars</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">read_int</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="n">size_bytes</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;CC&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">size_bytes</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">size_bytes</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse_type</span>
    <span class="k">case</span> <span class="n">get_chars</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">when</span> <span class="s2">&quot;BM&quot;</span>
      <span class="ss">:bmp</span>
    <span class="k">when</span> <span class="s2">&quot;GI&quot;</span>
      <span class="ss">:gif</span>
    <span class="k">when</span> <span class="mh">0xff</span><span class="o">.</span><span class="n">chr</span> <span class="o">+</span> <span class="mh">0xd8</span><span class="o">.</span><span class="n">chr</span>
      <span class="ss">:jpeg</span>
    <span class="k">when</span> <span class="mh">0x89</span><span class="o">.</span><span class="n">chr</span> <span class="o">+</span> <span class="s2">&quot;P&quot;</span>
      <span class="ss">:png</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="no">UnknownImageType</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse_size_for_gif</span>
    <span class="n">get_chars</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">[</span><span class="mi">6</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="o">].</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;SS&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse_size_for_png</span>
    <span class="n">get_chars</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span><span class="o">[</span><span class="mi">16</span><span class="o">.</span><span class="n">.</span><span class="mi">24</span><span class="o">].</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;NN&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse_size_for_jpeg</span>
    <span class="kp">loop</span> <span class="k">do</span>
      <span class="vi">@state</span> <span class="o">=</span> <span class="k">case</span> <span class="vi">@state</span>
      <span class="k">when</span> <span class="kp">nil</span>
        <span class="n">get_chars</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="ss">:started</span>
      <span class="k">when</span> <span class="ss">:started</span>
        <span class="n">get_byte</span> <span class="o">==</span> <span class="mh">0xFF</span> <span class="o">?</span> <span class="ss">:sof</span> <span class="p">:</span> <span class="ss">:started</span>          
      <span class="k">when</span> <span class="ss">:sof</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">get_byte</span>
        <span class="k">if</span> <span class="p">(</span><span class="mh">0xe0</span><span class="o">.</span><span class="n">.</span><span class="mh">0xef</span><span class="p">)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
          <span class="ss">:skipframe</span>
        <span class="k">elsif</span> <span class="o">[</span><span class="mh">0xC0</span><span class="o">.</span><span class="n">.</span><span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0xC5</span><span class="o">.</span><span class="n">.</span><span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0xC9</span><span class="o">.</span><span class="n">.</span><span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0xCD</span><span class="o">.</span><span class="n">.</span><span class="mh">0xCF</span><span class="o">].</span><span class="n">detect</span> <span class="p">{</span><span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">r</span><span class="o">.</span><span class="n">include?</span> <span class="n">c</span><span class="p">}</span>
          <span class="ss">:readsize</span>
        <span class="k">else</span>
          <span class="ss">:skipframe</span>
        <span class="k">end</span>
      <span class="k">when</span> <span class="ss">:skipframe</span>
        <span class="vi">@skip_chars</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">(</span><span class="n">get_chars</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="ss">:do_skip</span>
      <span class="k">when</span> <span class="ss">:do_skip</span>
        <span class="n">get_chars</span><span class="p">(</span><span class="vi">@skip_chars</span><span class="p">)</span>
        <span class="ss">:started</span>
      <span class="k">when</span> <span class="ss">:readsize</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">get_chars</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">[</span><span class="n">read_int</span><span class="p">(</span><span class="n">s</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="n">.</span><span class="mi">6</span><span class="o">]</span><span class="p">),</span> <span class="n">read_int</span><span class="p">(</span><span class="n">s</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">4</span><span class="o">]</span><span class="p">)</span><span class="o">]</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse_size_for_bmp</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">get_chars</span><span class="p">(</span><span class="mi">29</span><span class="p">)</span><span class="o">[</span><span class="mi">14</span><span class="o">.</span><span class="n">.</span><span class="mi">28</span><span class="o">]</span>
    <span class="n">d</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="mi">40</span> <span class="o">?</span> <span class="n">d</span><span class="o">[</span><span class="mi">4</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;LL&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="n">d</span><span class="o">[</span><span class="mi">4</span><span class="o">.</span><span class="n">.</span><span class="mi">8</span><span class="o">].</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;SS&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
